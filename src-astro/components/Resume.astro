---
import "../styles/global.css";
import resume from "../data/resume.json";

const formatDate = (date) =>
  date.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });

const calcTenure = (startDate, endDate) => {
  if (!startDate) return "";
  const start = new Date(startDate);
  const now = new Date();
  const endLabel = endDate && endDate !== "Present" ? endDate : "Present";

  const months =
    now.getFullYear() * 12 + now.getMonth() -
    (start.getFullYear() * 12 + start.getMonth());
  const years = Math.floor(months / 12);
  const remMonths = months % 12;

  const tenure =
    years > 0
      ? `${years} yr${years > 1 ? "s" : ""} ${remMonths} mo`
      : `${remMonths} mo`;

  return `${tenure} · ${formatDate(start)} – ${endLabel}`;
};

const extractYear = (meta) => {
  if (!meta) return "";
  const rangeMatch = meta.match(/\b(19|20)\d{2}\s*–\s*(Present|(19|20)\d{2})\b/);
  const singleYearMatch = meta.match(/\b(19|20)\d{2}\b/);
  return rangeMatch ? rangeMatch[0] : singleYearMatch ? singleYearMatch[0] : "";
};

const detailLines = (details) =>
  details ? details.trim().split("\n").filter((l) => l.trim()) : [];

const sectionIcon = (key) => {
  switch (key) {
    case "work":
      return "⎯";
    case "projects":
      return "◈";
    case "research":
      return "✦";
    default:
      return "•";
  }
};
---

<section class="page-shell">
  <div class="page-inner resume-story">
    <div class="hero-block" data-reveal>
      <span class="hero-kicker">Resume</span>
      <h1 class="hero-title">Story Timeline</h1>
      <p class="hero-subtitle">
        A narrative timeline of work, research, and projects designed for
        readability across all devices.
      </p>
      <p class="section-hint">
        Tip: Tap any card to expand for details. On desktop, use arrow keys to
        browse the project and research showcase.
      </p>
    </div>

    {Object.entries(resume)
      .filter(([sectionKey]) => sectionKey !== "education")
      .map(([sectionKey, section]) => (
      <section class="story-section" id={sectionKey} data-reveal>
        <div class="story-head">
          <div class="section-line">
            <h2 class="section-title">
              <span class="section-icon">{sectionIcon(sectionKey)}</span>
              {section.label}
            </h2>
            <button class="copy-link" type="button" data-copy={sectionKey}>
              Copy link
            </button>
          </div>
          <p class="section-subtitle">{section.description}</p>
          {sectionKey === "work" ? (
            <p class="section-hint">Hint: Click a role to expand highlights.</p>
          ) : (
            <p class="section-hint">
              Hint: Select a card to see the deep‑dive panel. Tap to expand on
              mobile.
            </p>
          )}
        </div>

        {section.items.length === 0 ? (
          <div class="empty-card">
            No items published yet. Updates coming soon.
          </div>
        ) : sectionKey === "work" ? (
          <div class="story-list">
            {section.items.map((item) => {
              const year = extractYear(item.meta);
              const tenure = calcTenure(item.startDate, item.endDate);
              const lines = detailLines(item.details);
              const showSkills = Array.isArray(item.skills) && item.skills.length;

              return (
                <details class="story-card" data-reveal>
                  <summary class="story-summary" title="Click to expand">
                    <div class="story-rail">
                      <span class="rail-dot"></span>
                      <span class="rail-line"></span>
                    </div>

                    <div class="story-body">
                      <div class="story-top">
                        <div>
                          <div class="story-title">{item.title}</div>
                          <div class="story-intro">{item.intro}</div>
                          {tenure && <div class="story-tenure">{tenure}</div>}
                        </div>
                        <div class="story-meta">
                          {year && <span class="chip">{year}</span>}
                          {item.meta && <span class="chip ghost">{item.meta}</span>}
                          {item.github && <span class="chip accent">source</span>}
                          <span class="chev">more</span>
                        </div>
                      </div>

                      {showSkills && (
                        <div class="story-block">
                          <div class="block-label">Skills</div>
                          <div class="skill-row">
                            {item.skills.map((s) => (
                              <span class="skill-pill">{s}</span>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </summary>

                  <div class="story-details">
                    {lines.length > 0 && (
                      <div class="story-block">
                        <div class="block-label">Highlights</div>
                        <ul class="detail-list">
                          {lines.map((line) => (
                            <li>{line}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {item.note && (
                      <div class="story-block">
                        <div class="block-label">Note</div>
                        <p class="detail-note">{item.note}</p>
                      </div>
                    )}

                    {Array.isArray(item.references) && item.references.length > 0 && (
                      <div class="story-block">
                        <div class="block-label">References</div>
                        <ul class="detail-list">
                          {item.references.map((r) => (
                            <li><a href={r.url} target="_blank">{r.label}</a></li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                </details>
              );
            })}
          </div>
        ) : (
          <div class="showcase" data-showcase={sectionKey} data-reveal>
            <div class="showcase-list">
              {section.items.map((item, idx) => {
                const year = extractYear(item.meta);
                const lines = detailLines(item.details);
                const showContributors =
                  (sectionKey === "research" || sectionKey === "projects") &&
                  item.contributors.length > 1;
                const showSkills = Array.isArray(item.skills) && item.skills.length;
                return (
                  <details class="showcase-item" data-index={idx}>
                    <summary class="showcase-summary" title="Tap to expand">
                      <div class="showcase-title">{item.title}</div>
                      <div class="showcase-intro">{item.intro}</div>
                      <div class="showcase-meta">
                        {year && <span class="chip">{year}</span>}
                        {item.meta && <span class="chip ghost">{item.meta}</span>}
                        {item.github && <span class="chip accent">source</span>}
                      </div>
                    </summary>

                    <div class="showcase-mobile">
                      {showSkills && (
                        <div class="story-block">
                          <div class="block-label">Stack</div>
                          <div class="skill-row">
                            {item.skills.map((s) => (
                              <span class="skill-pill">{s}</span>
                            ))}
                          </div>
                        </div>
                      )}

                      {lines.length > 0 && (
                        <div class="story-block">
                          <div class="block-label">Highlights</div>
                          <ul class="detail-list">
                            {lines.map((line) => (
                              <li>{line}</li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {item.note && (
                        <div class="story-block">
                          <div class="block-label">Note</div>
                          <p class="detail-note">{item.note}</p>
                        </div>
                      )}

                      {showContributors && (
                        <div class="story-block">
                          <div class="block-label">Contributors</div>
                          <ul class="detail-list">
                            {item.contributors.map((c) => (
                              <li>{c.name} — {c.role}</li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {Array.isArray(item.references) && item.references.length > 0 && (
                        <div class="story-block">
                          <div class="block-label">References</div>
                          <ul class="detail-list">
                            {item.references.map((r) => (
                              <li><a href={r.url} target="_blank">{r.label}</a></li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {item.github && (
                        <div class="story-block">
                          <div class="block-label">Source</div>
                          <a class="detail-link" href={item.github} target="_blank">
                            View repository
                          </a>
                        </div>
                      )}
                    </div>
                  </details>
                );
              })}
            </div>

            <div class="showcase-panel">
              {section.items.map((item, idx) => {
                const showContributors =
                  (sectionKey === "research" || sectionKey === "projects") &&
                  item.contributors.length > 1;
                const showSkills = Array.isArray(item.skills) && item.skills.length;
                const lines = detailLines(item.details);

                return (
                  <div class="showcase-card" data-index={idx}>
                    <div class="showcase-card-head">
                      <div>
                        <div class="showcase-card-title">{item.title}</div>
                        <div class="showcase-card-intro">{item.intro}</div>
                      </div>
                      {item.meta && <span class="chip ghost">{item.meta}</span>}
                    </div>

                    {showSkills && (
                      <div class="story-block">
                        <div class="block-label">Stack</div>
                        <div class="skill-row">
                          {item.skills.map((s) => (
                            <span class="skill-pill">{s}</span>
                          ))}
                        </div>
                      </div>
                    )}

                    {lines.length > 0 && (
                      <div class="story-block">
                        <div class="block-label">Highlights</div>
                        <ul class="detail-list">
                          {lines.map((line) => (
                            <li>{line}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {item.note && (
                      <div class="story-block">
                        <div class="block-label">Note</div>
                        <p class="detail-note">{item.note}</p>
                      </div>
                    )}

                    {showContributors && (
                      <div class="story-block">
                        <div class="block-label">Contributors</div>
                        <ul class="detail-list">
                          {item.contributors.map((c) => (
                            <li>{c.name} — {c.role}</li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {Array.isArray(item.references) && item.references.length > 0 && (
                      <div class="story-block">
                        <div class="block-label">References</div>
                        <ul class="detail-list">
                          {item.references.map((r) => (
                            <li><a href={r.url} target="_blank">{r.label}</a></li>
                          ))}
                        </ul>
                      </div>
                    )}

                    {item.github && (
                      <div class="story-block">
                        <div class="block-label">Source</div>
                        <a class="detail-link" href={item.github} target="_blank">
                          View repository
                        </a>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </section>
    ))}
  </div>
</section>

<button id="backToTop" class="btn-ghost" type="button">
  Back to top
</button>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("[data-showcase]").forEach((section) => {
      const items = Array.from(section.querySelectorAll(".showcase-item"));
      const cards = Array.from(section.querySelectorAll(".showcase-card"));
      if (!items.length || !cards.length) return;

      if (!window.matchMedia("(min-width: 980px)").matches) {
        return;
      }

      const activate = (idx) => {
        items.forEach((item, i) => {
          item.classList.toggle("is-active", i === idx);
        });
        cards.forEach((card, i) => {
          card.classList.toggle("is-active", i === idx);
        });
      };

      activate(0);
      items.forEach((item, idx) => {
        item.addEventListener("mouseenter", () => activate(idx));
        item.addEventListener("focusin", () => activate(idx));
        item.addEventListener("click", () => activate(idx));
      });

      section.addEventListener("keydown", (event) => {
        if (!["ArrowDown", "ArrowUp", "ArrowRight", "ArrowLeft"].includes(event.key)) {
          return;
        }
        const current = items.findIndex((item) => item.classList.contains("is-active"));
        if (current === -1) return;
        const delta = event.key === "ArrowDown" || event.key === "ArrowRight" ? 1 : -1;
        const next = (current + delta + items.length) % items.length;
        const summary = items[next].querySelector("summary");
        if (summary) {
          summary.focus();
        } else {
          items[next].focus();
        }
        activate(next);
        event.preventDefault();
      });
    });

    const copyButtons = document.querySelectorAll("[data-copy]");
    copyButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const sectionId = btn.getAttribute("data-copy");
        if (!sectionId) return;
        const link = `${window.location.origin}${window.location.pathname}#${sectionId}`;
        try {
          await navigator.clipboard.writeText(link);
          btn.textContent = "Copied";
          setTimeout(() => {
            btn.textContent = "Copy link";
          }, 1400);
        } catch (err) {
          btn.textContent = "Copy failed";
          setTimeout(() => {
            btn.textContent = "Copy link";
          }, 1400);
        }
      });
    });

    const backToTop = document.getElementById("backToTop");
    if (backToTop) {
      const toggle = () => {
        backToTop.classList.toggle("is-visible", window.scrollY > 380);
      };
      toggle();
      window.addEventListener("scroll", toggle, { passive: true });
      backToTop.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }
  });
</script>

<style>
  .resume-story {
    gap: 3.5rem;
  }

  .story-section {
    display: grid;
    gap: 1.8rem;
  }

  .story-head {
    display: grid;
    gap: 0.5rem;
  }

  .section-hint {
    font-size: 0.8rem;
    color: var(--text-dim);
  }

  .section-line {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 0.8rem;
    align-items: center;
  }

  .section-icon {
    color: var(--accent-alt);
    margin-right: 0.4rem;
    font-size: 0.9rem;
  }

  .copy-link {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--text-dim);
    border: 1px solid rgba(255, 255, 255, 0.12);
    padding: 0.3rem 0.7rem;
    border-radius: 999px;
    transition: border-color 160ms ease, color 160ms ease;
  }

  .copy-link:hover,
  .copy-link:focus-visible {
    color: var(--text-primary);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .story-list {
    display: grid;
    gap: 1.6rem;
  }

  .story-card {
    position: relative;
    border-radius: 26px;
    border: 1px solid rgba(205, 214, 244, 0.12);
    background: rgba(24, 24, 37, 0.55);
    backdrop-filter: blur(18px);
    transition: border-color 180ms ease, transform 180ms ease;
  }

  .story-card:hover {
    border-color: rgba(255, 255, 255, 0.32);
  }

  .story-card[open] {
    border-color: rgba(255, 255, 255, 0.28);
    transform: translateY(-2px);
  }

  .story-summary {
    list-style: none;
    cursor: pointer;
    display: grid;
    gap: 1rem;
    padding: 1.4rem 1.8rem 1.4rem 2.4rem;
  }

  .story-summary::-webkit-details-marker {
    display: none;
  }

  .story-rail {
    position: absolute;
    left: 1.1rem;
    top: 1.6rem;
    bottom: 1.6rem;
    width: 16px;
    display: grid;
    place-items: start;
  }

  .rail-dot {
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: var(--accent);
    box-shadow: 0 0 0 6px rgba(142, 242, 193, 0.12);
    z-index: 1;
  }

  .rail-line {
    position: absolute;
    top: 12px;
    bottom: 0;
    left: 4px;
    width: 2px;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.25), transparent);
  }

  .story-body {
    display: grid;
    gap: 1.2rem;
  }

  .story-top {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: space-between;
  }

  .story-title {
    font-size: 1.1rem;
    color: var(--text-primary);
  }

  .story-intro {
    color: var(--text-muted);
  }

  .story-tenure {
    margin-top: 0.4rem;
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  .story-meta {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-dim);
  }

  .chip {
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.08);
    transition: transform 150ms ease;
  }

  .chip:hover {
    transform: translateY(-1px);
  }

  .chip.ghost {
    opacity: 0.7;
  }

  .chip.accent {
    background: rgba(142, 242, 193, 0.2);
    color: var(--accent);
  }

  .chev {
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.65rem;
  }

  .story-block {
    display: grid;
    gap: 0.5rem;
  }

  .story-details {
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    padding: 0 1.8rem 1.6rem 2.4rem;
    display: grid;
    gap: 1rem;
  }

  .block-label {
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  .detail-list {
    display: grid;
    gap: 0.35rem;
    color: var(--text-muted);
  }

  .detail-note {
    color: var(--text-muted);
  }

  .detail-link,
  .detail-list a {
    color: var(--accent-alt);
  }

  .skill-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .skill-pill {
    padding: 0.3rem 0.7rem;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.08);
    color: var(--text-muted);
    font-size: 0.75rem;
  }

  .showcase {
    display: grid;
    gap: 1.6rem;
  }

  .showcase-list {
    display: grid;
    gap: 1rem;
  }

  .showcase-item {
    text-align: left;
    padding: 1.2rem 1.4rem;
    border-radius: 18px;
    border: 1px solid rgba(205, 214, 244, 0.12);
    background: rgba(20, 20, 32, 0.55);
    display: grid;
    gap: 0.6rem;
    transition: border-color 160ms ease, transform 160ms ease;
  }

  .showcase-item:hover,
  .showcase-item.is-active,
  .showcase-item[open] {
    border-color: rgba(255, 255, 255, 0.35);
    transform: translateY(-2px);
  }

  .showcase-summary {
    list-style: none;
    cursor: pointer;
    display: grid;
    gap: 0.6rem;
  }

  .showcase-summary::-webkit-details-marker {
    display: none;
  }

  .showcase-summary:focus-visible {
    outline: 2px solid rgba(142, 242, 193, 0.6);
    outline-offset: 4px;
    border-radius: 12px;
  }

  .empty-card {
    border-radius: 18px;
    border: 1px dashed rgba(255, 255, 255, 0.2);
    padding: 1.6rem;
    color: var(--text-muted);
    background: rgba(10, 14, 24, 0.5);
  }

  .showcase-mobile {
    display: none;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    padding-top: 1rem;
    gap: 1rem;
  }

  .showcase-title {
    color: var(--text-primary);
  }

  .showcase-intro {
    color: var(--text-muted);
  }

  .showcase-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    font-size: 0.72rem;
    color: var(--text-dim);
  }

  .showcase-panel {
    position: relative;
    border-radius: 24px;
    border: 1px solid rgba(205, 214, 244, 0.12);
    background: rgba(20, 20, 32, 0.55);
    backdrop-filter: blur(18px);
    padding: 1.6rem;
    min-height: 320px;
  }

  .showcase-card {
    display: none;
    gap: 1rem;
  }

  .showcase-card.is-active {
    display: grid;
  }

  .showcase-card-head {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1rem;
  }

  .showcase-card-title {
    font-size: 1.2rem;
    color: var(--text-primary);
  }

  .showcase-card-intro {
    color: var(--text-muted);
  }

  @media (min-width: 980px) {
    .showcase {
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
      align-items: start;
    }

    .showcase-panel {
      min-height: 420px;
    }
  }

  @media (max-width: 979px) {
    .showcase-panel {
      display: none;
    }

    .showcase-mobile {
      display: grid;
    }
  }

  @media (max-width: 899px) {
    .story-summary {
      padding: 1.2rem 1.4rem 1.2rem 2.1rem;
    }

    .story-rail {
      left: 0.8rem;
    }

    .story-details {
      padding: 0 1.4rem 1.4rem 2.1rem;
    }

    .story-top {
      flex-direction: column;
      align-items: flex-start;
    }
  }

  #backToTop {
    position: fixed;
    right: 1.5rem;
    bottom: 1.5rem;
    z-index: 20;
    opacity: 0;
    pointer-events: none;
    transition: opacity 160ms ease, transform 160ms ease;
    transform: translateY(6px);
  }

  #backToTop.is-visible {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

</style>
